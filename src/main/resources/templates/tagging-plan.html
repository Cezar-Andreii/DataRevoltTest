<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagging Plan - Google Sheet Style</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/tagging-style.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="logo-container">
                    <img src="/images/logo.png" alt="Logo">
                </div>
                <h1 class="text-center mb-4">Tagging Plan - Event Tracking</h1>

                <!-- Afișarea erorilor -->
                <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:if="${param.error == 'google-sheets-error'}">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Eroare la crearea Google Sheet:</strong>
                        <span th:text="${param.message}">Eroare necunoscută</span>
                        <br><small>Verifică console-ul pentru detalii suplimentare.</small>
                    </span>
                    <span th:if="${param.error == 'no-data'}">
                        <i class="bi bi-info-circle"></i>
                        <strong>Nu există date pentru export.</strong> Generează mai întâi un tagging plan.
                    </span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Formular pentru selectarea evenimentelor -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Selectează Evenimente pentru Generare Automată</h5>
                        <small class="text-muted">Selectează unul sau mai multe evenimente. Parametrii oficiali vor fi
                            adăugați automat.</small>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/tagging/generate}" method="post">
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label">Evenimente disponibile:</label>
                                    <div class="events-grid"
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa;">
                                        <div th:each="event : ${events}" class="form-check event-card"
                                            style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; transition: all 0.2s ease;">
                                            <input class="form-check-input" type="checkbox"
                                                th:id="'event_' + ${event.event}" th:name="selectedEvents"
                                                th:value="${event.event}" style="transform: scale(1.2);">
                                            <label class="form-check-label" th:for="'event_' + ${event.event}"
                                                style="cursor: pointer; width: 100%;">
                                                <div class="event-info">
                                                    <div class="event-name"
                                                        style="font-weight: bold; color: #495057; margin-bottom: 5px;"
                                                        th:text="${event.eventName}"></div>
                                                    <div class="event-description"
                                                        style="font-size: 0.9em; color: #6c757d; margin-bottom: 8px;"
                                                        th:text="${event.purpose}"></div>
                                                    <div class="event-trigger"
                                                        style="font-size: 0.8em; color: #868e96; font-style: italic;"
                                                        th:text="'Trigger: ' + ${event.trigger}"></div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    id="selectAllBtn">Selectează Tot</button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    id="deselectAllBtn">Deselectează Tot</button>
                                                <button type="button" class="btn btn-outline-success btn-sm"
                                                    id="createCustomEventBtn">
                                                    <i class="bi bi-plus-circle"></i> Creează Event Custom
                                                </button>
                                            </div>
                                            <div>
                                                <span class="badge bg-info" id="selectedCount">0 evenimente
                                                    selectate</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 d-flex gap-2 align-items-center">
                                <button type="button" class="btn btn-primary btn-lg" id="generateTableBtn">
                                    <i class="bi bi-magic"></i> Generează Tabel cu Parametrii Oficiali
                                </button>
                                <a href="https://developers.google.com/analytics/devguides/collection/ga4/reference/events?sjid=1480311239367543508-EU&client_type=gtag&authuser=1&hl=en#purchase"
                                    target="_blank" class="btn btn-outline-primary btn-lg">
                                    <i class="bi bi-book"></i> Link către documentația oficială
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tabelul de tip Google Sheet -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Tagging Plan Sheet</h5>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-info"
                                th:text="'Total rânduri: ' + ${#lists.size(taggingRows)}"></span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary btn-sm" id="addCustomRowBtn">
                                    <i class="bi bi-plus-circle"></i> Add Custom Row
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" id="resetTableBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-trash"></i> Reset Table
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="exportBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-google"></i> Creează Google Sheet
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="exportGoogleManualBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-clipboard"></i> Export Google fără API
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="exportCsvBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="exportJsonBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-file-earmark-code"></i> Export JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover mb-0" id="taggingTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="width: 8%;">Event Name</th>
                                        <th style="width: 8%;">Event Category</th>
                                        <th style="width: 12%;">Event Description</th>
                                        <th style="width: 8%;">Event Location</th>
                                        <th style="width: 8%;">Property Group</th>
                                        <th style="width: 8%;">Property Label</th>
                                        <th style="width: 8%;">Property Name</th>
                                        <th style="width: 15%;">Property Definition</th>
                                        <th style="width: 8%;">Data Type</th>
                                        <th style="width: 10%;">Possible Values</th>
                                        <th style="width: 15%;">Code Examples</th>
                                        <th style="width: 8%;">DATA LAYER STATUS</th>
                                        <th style="width: 8%;">STATUS GA4</th>
                                        <th style="width: 5%;">Actions</th>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Any meaningful action a user takes within your product. By "event"
                                                this refers to a dataLayer event, not necessary with an exact
                                                correspondent in Google Analytics</strong></td>
                                        <td><strong>General category of the event. "Utility" events are not collected
                                                directly, but rather used as support by the rest of the
                                                implementation.</strong></td>
                                        <td><strong>Description of the event being performed (for any given end user to
                                                understand)</strong></td>
                                        <td><strong>The pages where the event can trigger.</strong></td>
                                        <td><strong>Analytics or Custom Property. If Custom Property, the property needs
                                                to be created in Google Analytics</strong></td>
                                        <td><strong>Metric or Dimension</strong></td>
                                        <td><strong>Any rich metadata associated to the event, either describing the
                                                event itself or the user performing that event</strong></td>
                                        <td><strong>Description of the property associated with the event being
                                                performed (for any given end user to understand)</strong></td>
                                        <td><strong>One of six possible data types</strong></td>
                                        <td><strong>Sample value of the property or all possible values. As a general
                                                rule, when the value, for any reason, is not available, the value is set
                                                to undefined</strong></td>
                                        <td><strong>These are examples of how the codes should look like</strong></td>
                                        <td><strong>Whether the event/property has been implemented or not</strong></td>
                                        <td><strong>Whether the event/property has been implemented or not</strong></td>
                                        <td></td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="row, iterStat : ${taggingRows}" th:id="'row-' + ${iterStat.index}"
                                        th:class="${row.eventName != '' and row.eventName != null} ? 'table-primary' : ''">
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventName}" th:name="'eventName_' + ${iterStat.index}"
                                                th:id="'eventName_' + ${iterStat.index}" data-field="eventName"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventName == '' or row.eventName == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventCategory}"
                                                th:name="'eventCategory_' + ${iterStat.index}"
                                                th:id="'eventCategory_' + ${iterStat.index}" data-field="eventCategory"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventCategory == '' or row.eventCategory == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventDescription}"
                                                th:name="'eventDescription_' + ${iterStat.index}"
                                                th:id="'eventDescription_' + ${iterStat.index}"
                                                data-field="eventDescription" th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventDescription == '' or row.eventDescription == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventLocation}"
                                                th:name="'eventLocation_' + ${iterStat.index}"
                                                th:id="'eventLocation_' + ${iterStat.index}" data-field="eventLocation"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventLocation == '' or row.eventLocation == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyGroup}"
                                                th:name="'propertyGroup_' + ${iterStat.index}"
                                                th:id="'propertyGroup_' + ${iterStat.index}" data-field="propertyGroup"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyGroup == '' or row.propertyGroup == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyLabel}"
                                                th:name="'propertyLabel_' + ${iterStat.index}"
                                                th:id="'propertyLabel_' + ${iterStat.index}" data-field="propertyLabel"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyLabel == '' or row.propertyLabel == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyName}"
                                                th:name="'propertyName_' + ${iterStat.index}"
                                                th:id="'propertyName_' + ${iterStat.index}" data-field="propertyName"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyName == '' or row.propertyName == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyDefinition}"
                                                th:name="'propertyDefinition_' + ${iterStat.index}"
                                                th:id="'propertyDefinition_' + ${iterStat.index}"
                                                data-field="propertyDefinition"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyDefinition == '' or row.propertyDefinition == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.dataType}" th:name="'dataType_' + ${iterStat.index}"
                                                th:id="'dataType_' + ${iterStat.index}" data-field="dataType"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.dataType == '' or row.dataType == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.possibleValues}"
                                                th:name="'possibleValues_' + ${iterStat.index}"
                                                th:id="'possibleValues_' + ${iterStat.index}"
                                                data-field="possibleValues" th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.possibleValues == '' or row.possibleValues == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <textarea class="form-control form-control-sm editable-cell"
                                                th:text="${row.codeExamples}"
                                                th:name="'codeExamples_' + ${iterStat.index}"
                                                th:id="'codeExamples_' + ${iterStat.index}" data-field="codeExamples"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.codeExamples == '' or row.codeExamples == null} ? 'bg-light' : ''"
                                                rows="3" placeholder="Enter code examples..."></textarea>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.dataLayerStatus}"
                                                th:name="'dataLayerStatus_' + ${iterStat.index}"
                                                th:id="'dataLayerStatus_' + ${iterStat.index}"
                                                data-field="dataLayerStatus" th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.dataLayerStatus == '' or row.dataLayerStatus == null} ? 'bg-light' : ''"
                                                placeholder="yes">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.statusGA4}" th:name="'statusGA4_' + ${iterStat.index}"
                                                th:id="'statusGA4_' + ${iterStat.index}" data-field="statusGA4"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.statusGA4 == '' or row.statusGA4 == null} ? 'bg-light' : ''"
                                                placeholder="yes">
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                                                    title="Edit" th:attr="data-row-index=${iterStat.index}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-btn"
                                                    title="Delete" th:attr="data-row-index=${iterStat.index}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(taggingRows)}">
                                        <td colspan="14" class="text-center text-muted py-4">
                                            Nu există rânduri în tagging plan. Selectează un eveniment și parametri
                                            pentru a genera planul.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal pentru editare -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editare Rând</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/tagging/update}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="editRowIndex" name="rowIndex">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEvent" class="form-label">Event</label>
                                <input type="text" class="form-control" id="editEvent" name="event" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEventName" class="form-label">Event Name</label>
                                <input type="text" class="form-control" id="editEventName" name="eventName" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="editPurpose" class="form-label">Purpose</label>
                                <input type="text" class="form-control" id="editPurpose" name="purpose" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="editTrigger" class="form-label">Trigger</label>
                                <input type="text" class="form-control" id="editTrigger" name="trigger" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editParameterName" class="form-label">Parameter Name</label>
                                <input type="text" class="form-control" id="editParameterName" name="parameterName"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editExampleValue" class="form-label">Example Value</label>
                                <input type="text" class="form-control" id="editExampleValue" name="exampleValue"
                                    required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="editParameterDescription" class="form-label">Parameter Description</label>
                                <input type="text" class="form-control" id="editParameterDescription"
                                    name="parameterDescription" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                        <button type="submit" class="btn btn-primary">Salvează</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pentru confirmare ștergere -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmare Ștergere</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Ești sigur că vrei să ștergi acest rând?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <form th:action="@{/tagging/delete}" method="post" style="display: inline;">
                        <input type="hidden" id="deleteRowIndex" name="rowIndex">
                        <button type="submit" class="btn btn-danger">Șterge</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pentru selectarea opțiunilor din array-ul de items -->
    <div class="modal fade" id="itemsArrayModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ce să conțină array-ul de items?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Selectează opțiunile pe care dorești să le includi în array-ul de items:</p>

                    <!-- Parametri standard -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_id" value="item_id" checked>
                                <label class="form-check-label" for="item_id">item_id</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_name" value="item_name"
                                    checked>
                                <label class="form-check-label" for="item_name">item_name</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_category" value="item_category"
                                    checked>
                                <label class="form-check-label" for="item_category">item_category</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_category2"
                                    value="item_category2">
                                <label class="form-check-label" for="item_category2">item_category2</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_category3"
                                    value="item_category3">
                                <label class="form-check-label" for="item_category3">item_category3</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_brand" value="item_brand">
                                <label class="form-check-label" for="item_brand">item_brand</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_variant" value="item_variant">
                                <label class="form-check-label" for="item_variant">item_variant</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_list_id" value="item_list_id">
                                <label class="form-check-label" for="item_list_id">item_list_id</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item_list_name"
                                    value="item_list_name">
                                <label class="form-check-label" for="item_list_name">item_list_name</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="price" value="price">
                                <label class="form-check-label" for="price">price</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="quantity" value="quantity">
                                <label class="form-check-label" for="quantity">quantity</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="discount" value="discount">
                                <label class="form-check-label" for="discount">discount</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="affiliation" value="affiliation">
                                <label class="form-check-label" for="affiliation">affiliation</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="coupon" value="coupon">
                                <label class="form-check-label" for="coupon">coupon</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="index" value="index">
                                <label class="form-check-label" for="index">index</label>
                            </div>
                        </div>
                    </div>

                    <!-- Opțiune pentru parametri custom -->
                    <hr class="my-3">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Adaugă parametru custom:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="customItemParam"
                                placeholder="ex: item_color, item_size, etc.">
                            <button type="button" class="btn btn-outline-secondary" id="addCustomItemBtn">
                                <i class="bi bi-plus-circle"></i> Adaugă
                            </button>
                        </div>
                        <small class="text-muted">Parametrii custom adăugați vor apărea mai jos.</small>
                    </div>

                    <!-- Lista parametrilor custom adăugați -->
                    <div id="customItemsList" class="mb-3">
                        <!-- Parametrii custom vor fi adăugați aici dinamic -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <button type="button" class="btn btn-primary" id="confirmGenerateBtn">
                        <i class="bi bi-check"></i> Confirmă și Generează
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pentru crearea unui event custom -->
    <div class="modal fade" id="createCustomEventModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Creează Event Custom
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Completează toate câmpurile pentru a crea un event custom în tabel.</strong>
                        <p class="mb-0">Eventul va fi adăugat în tabel după confirmare.</p>
                    </div>

                    <form id="customEventForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="custom_eventName" class="form-label fw-bold">
                                    Event Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="custom_eventName"
                                    placeholder="ex: purchase, view_item, add_to_cart" required>
                                <small class="text-muted">Any meaningful action a user takes within your product</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="custom_eventCategory" class="form-label fw-bold">
                                    Event Category
                                </label>
                                <input type="text" class="form-control" id="custom_eventCategory"
                                    placeholder="ex: Ecommerce, Engagement, etc.">
                                <small class="text-muted">General category of the event</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="custom_eventDescription" class="form-label fw-bold">
                                    Event Description
                                </label>
                                <textarea class="form-control" id="custom_eventDescription" rows="2"
                                    placeholder="Description of the event being performed"></textarea>
                                <small class="text-muted">Description of the event (for any given end user to
                                    understand)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="custom_eventLocation" class="form-label fw-bold">
                                    Event Location
                                </label>
                                <input type="text" class="form-control" id="custom_eventLocation"
                                    placeholder="ex: /checkout, /product, etc.">
                                <small class="text-muted">The pages where the event can trigger</small>
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="custom_propertyGroup" class="form-label fw-bold">
                                    Property Group
                                </label>
                                <input type="text" class="form-control" id="custom_propertyGroup"
                                    placeholder="ex: Analytics, Custom">
                                <small class="text-muted">Analytics or Custom Property</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="custom_propertyLabel" class="form-label fw-bold">
                                    Property Label
                                </label>
                                <input type="text" class="form-control" id="custom_propertyLabel"
                                    placeholder="ex: Metric, Dimension">
                                <small class="text-muted">Metric or Dimension</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="custom_propertyName" class="form-label fw-bold">
                                    Property Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="custom_propertyName"
                                    placeholder="ex: event, value, transaction_id" required>
                                <small class="text-muted">Any rich metadata associated to the event</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="custom_propertyDefinition" class="form-label fw-bold">
                                    Property Definition
                                </label>
                                <textarea class="form-control" id="custom_propertyDefinition" rows="2"
                                    placeholder="Description of the property associated with the event"></textarea>
                                <small class="text-muted">Description of the property (for any given end user to
                                    understand)</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="custom_dataType" class="form-label fw-bold">
                                    Data Type
                                </label>
                                <select class="form-select" id="custom_dataType">
                                    <option value="String">String</option>
                                    <option value="Numeric">Numeric</option>
                                    <option value="Boolean">Boolean</option>
                                    <option value="List of Objects">List of Objects</option>
                                    <option value="Object">Object</option>
                                    <option value="Date">Date</option>
                                </select>
                                <small class="text-muted">One of six possible data types</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="custom_possibleValues" class="form-label fw-bold">
                                    Possible Values
                                </label>
                                <input type="text" class="form-control" id="custom_possibleValues"
                                    placeholder="ex: 'yes', 'no', 'pending', etc.">
                                <small class="text-muted">Sample value or all possible values</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="custom_codeExamples" class="form-label fw-bold">
                                    Code Examples
                                </label>
                                <textarea class="form-control font-monospace" id="custom_codeExamples" rows="2"
                                    placeholder="JavaScript code example"></textarea>
                                <small class="text-muted">Examples of how the codes should look like</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="custom_dataLayerStatus" class="form-label fw-bold">
                                    DATA LAYER STATUS
                                </label>
                                <select class="form-select" id="custom_dataLayerStatus">
                                    <option value="yes">yes</option>
                                    <option value="no">no</option>
                                    <option value="pending">pending</option>
                                </select>
                                <small class="text-muted">Whether the event/property has been implemented or not</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="custom_statusGA4" class="form-label fw-bold">
                                    STATUS GA4
                                </label>
                                <select class="form-select" id="custom_statusGA4">
                                    <option value="yes">yes</option>
                                    <option value="no">no</option>
                                    <option value="pending">pending</option>
                                </select>
                                <small class="text-muted">Whether the event/property has been implemented or not</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <button type="button" class="btn btn-success" id="confirmCustomEventBtn">
                        <i class="bi bi-check-circle"></i> Adaugă Event în Tabel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"></script>
    <script>
        // Funcționalitate pentru editare inline
        document.addEventListener('DOMContentLoaded', function () {
            const editButtons = document.querySelectorAll('.edit-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            const editableCells = document.querySelectorAll('.editable-cell');
            const exportBtn = document.getElementById('exportBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const exportJsonBtn = document.getElementById('exportJsonBtn');

            // Funcționalitate pentru selectarea evenimentelor
            const eventCheckboxes = document.querySelectorAll('input[name="selectedEvents"]');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const selectedCount = document.getElementById('selectedCount');

            // Actualizează contorul de evenimente selectate
            function updateSelectedCount() {
                const selected = document.querySelectorAll('input[name="selectedEvents"]:checked');
                selectedCount.textContent = selected.length + ' evenimente selectate';
                selectedCount.className = selected.length > 0 ? 'badge bg-success' : 'badge bg-info';
            }

            // Adaugă event listeners pentru checkbox-uri
            eventCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateSelectedCount();
                    // Adaugă efect vizual pentru card-ul selectat
                    const card = this.closest('.event-card');
                    if (this.checked) {
                        card.style.backgroundColor = '#e3f2fd';
                        card.style.borderColor = '#2196f3';
                        card.style.transform = 'scale(1.02)';
                    } else {
                        card.style.backgroundColor = 'white';
                        card.style.borderColor = '#e9ecef';
                        card.style.transform = 'scale(1)';
                    }
                });
            });

            // Butonul Selectează Tot
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function () {
                    eventCheckboxes.forEach(checkbox => {
                        checkbox.checked = true;
                        const card = checkbox.closest('.event-card');
                        card.style.backgroundColor = '#e3f2fd';
                        card.style.borderColor = '#2196f3';
                        card.style.transform = 'scale(1.02)';
                    });
                    updateSelectedCount();
                });
            }

            // Butonul Deselectează Tot
            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', function () {
                    eventCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                        const card = checkbox.closest('.event-card');
                        card.style.backgroundColor = 'white';
                        card.style.borderColor = '#e9ecef';
                        card.style.transform = 'scale(1)';
                    });
                    updateSelectedCount();
                });
            }

            // Inițializează contorul
            updateSelectedCount();

            // Funcționalitate pentru butonul Generează Tabel
            const generateTableBtn = document.getElementById('generateTableBtn');
            if (generateTableBtn) {
                generateTableBtn.addEventListener('click', function () {
                    // Verifică dacă sunt selectate evenimente
                    const selectedEvents = document.querySelectorAll('input[name="selectedEvents"]:checked');
                    if (selectedEvents.length === 0) {
                        alert('Te rugăm să selectezi cel puțin un eveniment!');
                        return;
                    }

                    // Afișează modalul pentru selectarea opțiunilor din array-ul de items
                    const itemsModal = new bootstrap.Modal(document.getElementById('itemsArrayModal'));
                    itemsModal.show();
                });
            }

            // Funcționalitate pentru adăugarea parametrilor custom
            const addCustomItemBtn = document.getElementById('addCustomItemBtn');
            const customItemParam = document.getElementById('customItemParam');
            const customItemsList = document.getElementById('customItemsList');
            const customItemsSet = new Set(); // Pentru a evita duplicate

            if (addCustomItemBtn && customItemParam && customItemsList) {
                addCustomItemBtn.addEventListener('click', function () {
                    const customParam = customItemParam.value.trim();

                    if (!customParam) {
                        alert('Te rugăm să introduci un nume pentru parametrul custom!');
                        return;
                    }

                    // Verifică dacă parametrul nu există deja
                    if (customItemsSet.has(customParam)) {
                        alert('Acest parametru a fost deja adăugat!');
                        return;
                    }

                    // Adaugă parametrul în listă
                    customItemsSet.add(customParam);

                    // Creează elementul pentru parametrul custom
                    const customItemDiv = document.createElement('div');
                    customItemDiv.className = 'form-check mb-2';
                    customItemDiv.id = 'custom-item-' + customParam.replace(/[^a-zA-Z0-9]/g, '_');
                    customItemDiv.innerHTML = `
                        <input class="form-check-input custom-item-checkbox" type="checkbox" 
                               id="custom_${customParam.replace(/[^a-zA-Z0-9]/g, '_')}" 
                               value="${customParam}" checked>
                        <label class="form-check-label" for="custom_${customParam.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${customParam} <span class="badge bg-secondary">custom</span>
                        </label>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-custom-item" 
                                data-param="${customParam}">
                            <i class="bi bi-x"></i>
                        </button>
                    `;

                    customItemsList.appendChild(customItemDiv);

                    // Reset input
                    customItemParam.value = '';

                    // Adaugă event listener pentru butonul de ștergere
                    const removeBtn = customItemDiv.querySelector('.remove-custom-item');
                    removeBtn.addEventListener('click', function () {
                        customItemsSet.delete(customParam);
                        customItemDiv.remove();
                    });

                    // Permite Enter pentru a adăuga
                    customItemParam.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            addCustomItemBtn.click();
                        }
                    });
                });
            }

            // Funcționalitate pentru butonul de confirmare din modal
            const confirmGenerateBtn = document.getElementById('confirmGenerateBtn');
            if (confirmGenerateBtn) {
                confirmGenerateBtn.addEventListener('click', function () {
                    // Obține opțiunile selectate (standard)
                    const selectedItems = [];

                    // Parametri standard
                    const standardItems = [
                        'item_id', 'item_name', 'item_category', 'item_category2', 'item_category3',
                        'item_brand', 'item_variant', 'item_list_id', 'item_list_name',
                        'price', 'quantity', 'discount', 'affiliation', 'coupon', 'index'
                    ];

                    standardItems.forEach(itemId => {
                        const checkbox = document.getElementById(itemId);
                        if (checkbox && checkbox.checked) {
                            selectedItems.push(itemId);
                        }
                    });

                    // Parametri custom
                    const customCheckboxes = document.querySelectorAll('.custom-item-checkbox:checked');
                    customCheckboxes.forEach(checkbox => {
                        selectedItems.push(checkbox.value);
                    });

                    // Verifică dacă cel puțin o opțiune este selectată
                    if (selectedItems.length === 0) {
                        alert('Te rugăm să selectezi cel puțin o opțiune pentru array-ul de items!');
                        return;
                    }

                    // Obține evenimentele selectate
                    const selectedEvents = document.querySelectorAll('input[name="selectedEvents"]:checked');
                    const eventValues = Array.from(selectedEvents).map(cb => cb.value);

                    // Creează un formular ascuns și trimite-l
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/tagging/generate';

                    // Adaugă evenimentele selectate
                    eventValues.forEach(eventValue => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selectedEvents';
                        input.value = eventValue;
                        form.appendChild(input);
                    });

                    // Adaugă opțiunile selectate pentru items
                    selectedItems.forEach(item => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selectedItems';
                        input.value = item;
                        form.appendChild(input);
                    });

                    // Adaugă formularul la DOM și trimite-l
                    document.body.appendChild(form);
                    form.submit();
                });
            }

            // Editare inline directă
            editableCells.forEach(cell => {
                cell.addEventListener('dblclick', function () {
                    this.focus();
                    this.select();
                });

                cell.addEventListener('blur', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    const field = this.getAttribute('data-field');
                    const value = this.value;

                    // Verifică că avem datele necesare
                    if (rowIndex && field && value !== undefined) {
                        // Salvează automat modificarea
                        saveCellChange(rowIndex, field, value);
                    }
                });

                cell.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });
            });

            editButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    const row = document.getElementById('row-' + rowIndex);

                    // Populează modalul cu datele din rând
                    document.getElementById('editRowIndex').value = rowIndex;
                    document.getElementById('editEvent').value = row.querySelector('input[name="event_' + rowIndex + '"]').value;
                    document.getElementById('editEventName').value = row.querySelector('input[name="eventName_' + rowIndex + '"]').value;
                    document.getElementById('editPurpose').value = row.querySelector('input[name="purpose_' + rowIndex + '"]').value;
                    document.getElementById('editTrigger').value = row.querySelector('input[name="trigger_' + rowIndex + '"]').value;
                    document.getElementById('editParameterName').value = row.querySelector('input[name="parameterName_' + rowIndex + '"]').value;
                    document.getElementById('editExampleValue').value = row.querySelector('input[name="exampleValue_' + rowIndex + '"]').value;
                    document.getElementById('editParameterDescription').value = row.querySelector('input[name="parameterDescription_' + rowIndex + '"]').value;

                    // Afișează modalul
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                });
            });

            deleteButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    document.getElementById('deleteRowIndex').value = rowIndex;
                    new bootstrap.Modal(document.getElementById('deleteModal')).show();
                });
            });

            // Funcționalitate pentru export
            if (exportBtn) {
                exportBtn.addEventListener('click', function () {
                    // Redirecționează direct către endpoint-ul de export
                    window.location.href = '/tagging/export-google-sheet';
                });
            }

            // Funcționalitate pentru export CSV
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', function () {
                    // Download direct CSV
                    window.location.href = '/tagging/export-csv';
                });
            }

            // Funcționalitate pentru export JSON
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', function () {
                    // Afișează modal cu JSON
                    showJsonModal();
                });
            }

            // Funcționalitate pentru export Google fără API
            const exportGoogleManualBtn = document.getElementById('exportGoogleManualBtn');
            if (exportGoogleManualBtn) {
                exportGoogleManualBtn.addEventListener('click', function () {
                    // Afișează modal cu datele pentru copiere manuală
                    showDataModal();
                });
            }

            // Funcționalitate pentru butonul "Creează Event Custom" lângă evenimente
            const createCustomEventBtn = document.getElementById('createCustomEventBtn');
            if (createCustomEventBtn) {
                createCustomEventBtn.addEventListener('click', function () {
                    // Deschide modalul pentru event custom
                    const customEventModal = new bootstrap.Modal(document.getElementById('createCustomEventModal'));
                    customEventModal.show();
                });
            }

            // Funcționalitate pentru confirmarea eventului custom
            const confirmCustomEventBtn = document.getElementById('confirmCustomEventBtn');
            if (confirmCustomEventBtn) {
                confirmCustomEventBtn.addEventListener('click', function () {
                    const form = document.getElementById('customEventForm');

                    // Verifică dacă formularul este valid
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    // Obține valorile din formular
                    const eventData = {
                        eventName: document.getElementById('custom_eventName').value.trim(),
                        eventCategory: document.getElementById('custom_eventCategory').value.trim(),
                        eventDescription: document.getElementById('custom_eventDescription').value.trim(),
                        eventLocation: document.getElementById('custom_eventLocation').value.trim(),
                        propertyGroup: document.getElementById('custom_propertyGroup').value.trim(),
                        propertyLabel: document.getElementById('custom_propertyLabel').value.trim(),
                        propertyName: document.getElementById('custom_propertyName').value.trim(),
                        propertyDefinition: document.getElementById('custom_propertyDefinition').value.trim(),
                        dataType: document.getElementById('custom_dataType').value,
                        possibleValues: document.getElementById('custom_possibleValues').value.trim(),
                        codeExamples: document.getElementById('custom_codeExamples').value.trim(),
                        dataLayerStatus: document.getElementById('custom_dataLayerStatus').value,
                        statusGA4: document.getElementById('custom_statusGA4').value
                    };

                    // Verifică că cel puțin Event Name și Property Name sunt completate
                    if (!eventData.eventName || !eventData.propertyName) {
                        alert('Te rugăm să completezi cel puțin Event Name și Property Name!');
                        return;
                    }

                    // Trimite datele către backend
                    fetch('/tagging/add-custom-row', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: Object.keys(eventData).map(key => `${key}=${encodeURIComponent(eventData[key])}`).join('&')
                    })
                        .then(response => response.text())
                        .then(data => {
                            if (data.includes('successfully') || data.includes('already exists')) {
                                // Reîncarcă pagina pentru a vedea noul rând
                                window.location.reload();
                            } else {
                                alert('Eroare la adăugarea eventului: ' + data);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Eroare la adăugarea eventului custom. Verifică consola pentru detalii.');
                        });
                });
            }

            // Funcționalitate pentru butonul Add Custom Row
            const addCustomRowBtn = document.getElementById('addCustomRowBtn');
            if (addCustomRowBtn) {
                addCustomRowBtn.addEventListener('click', function () {
                    addCustomRow();
                });
            }

            // Funcționalitate pentru butonul Reset Table
            const resetTableBtn = document.getElementById('resetTableBtn');
            if (resetTableBtn) {
                resetTableBtn.addEventListener('click', function () {
                    showResetConfirmation();
                });
            }
        });

        // Funcție pentru salvarea automată a modificărilor
        function saveCellChange(rowIndex, field, value) {
            console.log('Saving cell change:', { rowIndex, field, value });

            // Verifică că rowIndex este număr
            const numericIndex = parseInt(rowIndex);

            if (isNaN(numericIndex)) {
                console.error('Invalid row index:', rowIndex, 'Type:', typeof rowIndex);
                alert('Eroare: Index rând invalid: ' + rowIndex);
                return;
            }

            // Verifică că field și value sunt valide
            if (!field || value === undefined) {
                console.error('Invalid field or value:', { field, value });
                return;
            }

            // Folosește AJAX pentru a trimite datele
            fetch('/tagging/update-cell', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `rowIndex=${numericIndex}&field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Cell updated successfully');
                    } else {
                        console.error('Failed to update cell, status:', response.status);
                        alert('Eroare la salvarea modificării! Status: ' + response.status);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Eroare la salvarea modificării: ' + error.message);
                });
        }

        // Funcție pentru afișarea modalului de export
        function showExportModal() {
            const modalHtml = `
                <div class="modal fade" id="exportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export Google Sheet</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Vrei să exportezi tagging plan-ul într-un Google Sheet?</p>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Notă:</strong> Se va genera un link către Google Sheets cu datele tale.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                                <button type="button" class="btn btn-success" onclick="exportToGoogleSheets()">
                                    <i class="bi bi-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('exportModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru export către Google Sheets
        function exportToGoogleSheets() {
            // Afișează modal cu datele pentru copiere
            showDataModal();
        }

        // Funcție pentru afișarea datelor în modal
        function showDataModal() {
            // Obține datele din tabel
            const table = document.getElementById('taggingTable');
            const rows = table.querySelectorAll('tbody tr');

            // Obține header-ul cu descrierile din prima linie
            const descriptionRow = table.querySelector('thead tr.table-info');
            const descriptionCells = descriptionRow ? descriptionRow.querySelectorAll('td') : [];

            // Folosește tab-uri în loc de virgule pentru separare
            let csvData = 'Event Name\tEvent Category\tEvent Description\tEvent Location\tProperty Group\tProperty Label\tProperty Name\tProperty Definition\tData Type\tPossible Values\tCode Examples\tDATA LAYER STATUS\tSTATUS GA4\n';

            // Adaugă linia cu descrierile din prima linie a tabelului
            if (descriptionCells.length > 0) {
                const descriptions = Array.from(descriptionCells).map(cell => {
                    // Curăță textul și înlocuiește newline-urile cu spații
                    let text = cell.textContent.trim();
                    // Înlocuiește newline-urile și tab-urile cu spații
                    text = text.replace(/[\n\r\t]+/g, ' ');
                    // Înlocuiește spațiile multiple cu un singur spațiu
                    text = text.replace(/\s+/g, ' ');
                    return text;
                });
                // Exclude ultima celulă (Actions) dacă există
                if (descriptions.length > 10) {
                    descriptions.pop();
                }
                csvData += descriptions.join('\t') + '\n';
            }

            rows.forEach(row => {
                const cells = row.querySelectorAll('td input, td textarea');
                if (cells.length >= 13) {
                    // Extrage valorile din input-uri și textarea-uri
                    const values = Array.from(cells).map((cell, index) => {
                        let value = cell.value;

                        // Pentru coloana Code Examples (index 10 - al 11-lea câmp)
                        // Trebuie să păstrăm newline-urile în aceeași celulă (K3)
                        // Pentru TSV, trebuie să înconjurăm valoarea cu ghilimele duble
                        if (index === 10) { // Code Examples este al 11-lea câmp (index 10)
                            // Escape ghilimele duble (CSV/TSV standard)
                            value = value.replace(/"/g, '""');
                            // Înconjoară cu ghilimele duble pentru a păstra newline-urile în aceeași celulă
                            // Google Sheets va interpreta corect acest format
                            value = '"' + value + '"';
                        } else {
                            // Pentru celelalte coloane, înlocuiește newline-urile cu spații
                            // pentru a evita rânduri noi neintenționate
                            value = value.replace(/[\n\r]+/g, ' ');
                            // Escape ghilimele duble dacă există
                            value = value.replace(/"/g, '""');
                            // Dacă conține tab-uri, ghilimele sau virgule, înconjoară cu ghilimele
                            if (value.includes('\t') || value.includes('"') || value.includes(',')) {
                                value = '"' + value + '"';
                            }
                        }
                        return value;
                    });

                    // Folosește tab-uri pentru separare între coloane
                    // Google Sheets va interpreta corect newline-urile din coloana Code Examples
                    // datorită ghilimelelor duble care înconjoară valoarea
                    const rowData = values.join('\t');
                    csvData += rowData + '\n';
                }
            });

            const modalHtml = `
                <div class="modal fade" id="dataModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export Manual către Google Sheets</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Export Manual către Google Sheets</strong> 
                                    <p class="mb-2">Datele sunt formatate cu tab-uri pentru separare perfectă în coloane în Google Sheets.</p>
                                    <ol class="mb-0">
                                        <li><strong>Click pe "Copiază Datele"</strong> pentru a copia toate datele în clipboard</li>
                                        <li><strong>Click pe "Deschide Google Sheets"</strong> pentru a deschide un sheet nou</li>
                                        <li><strong>Selectează celula A1</strong> în Google Sheets</li>
                                        <li><strong>Lipește datele folosind Paste Special:</strong>
                                            <ul class="mb-0 mt-2">
                                                <li>Click dreapta → <strong>Paste special → Paste values only</strong> SAU</li>
                                                <li>Folosește <strong>Ctrl+Shift+V</strong> (Windows) sau <strong>Cmd+Shift+V</strong> (Mac)</li>
                                            </ul>
                                        </li>
                                        <li><strong>Array-ul de items va apărea corect în coloana K (Code Examples)</strong> pe același rând, cu multiple linii în aceeași celulă!</li>
                                    </ol>
                                </div>
                                <div class="mb-3">
                                    <label for="csvData" class="form-label">Date pentru Google Sheets (format tab-separated):</label>
                                    <textarea class="form-control font-monospace" id="csvData" rows="15" readonly style="font-size: 0.85em;">${csvData}</textarea>
                                </div>
                                <div class="d-flex gap-2 mb-3">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="copyToClipboard()">
                                        <i class="bi bi-clipboard"></i> Copiază Datele
                                    </button>
                                    <button type="button" class="btn btn-success btn-lg" onclick="openGoogleSheets()">
                                        <i class="bi bi-google"></i> Deschide Google Sheets
                                    </button>
                                </div>
                                <div class="alert alert-light">
                                    <small><i class="bi bi-lightbulb"></i> <strong>Tip:</strong> După ce copiezi datele, butonul "Deschide Google Sheets" va deschide automat un sheet nou unde poți face paste direct.</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Închide</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('dataModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru copierea datelor în clipboard
        function copyToClipboard() {
            const textarea = document.getElementById('csvData');
            if (!textarea) {
                alert('❌ Eroare: Textarea-ul nu a fost găsit!');
                return;
            }

            textarea.select();
            textarea.setSelectionRange(0, 99999); // Pentru mobile

            try {
                document.execCommand('copy');
                // Feedback vizual
                const btn = event.target.closest('button');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Copiat!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                    }, 2000);
                }
            } catch (err) {
                // Fallback pentru browsere moderne
                navigator.clipboard.writeText(textarea.value).then(() => {
                    const btn = event.target.closest('button');
                    if (btn) {
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check-circle"></i> Copiat!';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-success');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-primary');
                        }, 2000);
                    }
                }).catch(() => {
                    alert('❌ Eroare la copierea datelor! Încearcă să selectezi manual textul și să-l copiezi.');
                });
            }
        }

        // Funcție pentru deschiderea Google Sheets
        function openGoogleSheets() {
            // Deschide Google Sheets nou într-un tab nou
            window.open('https://docs.google.com/spreadsheets/create', '_blank');

            // Feedback vizual
            const btn = event.target.closest('button');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Deschis!';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-info');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-success');
                }, 2000);
            }
        }

        // Funcție pentru afișarea JSON-ului în modal
        function showJsonModal() {
            // Obține datele din tabel și grupează după event
            const table = document.getElementById('taggingTable');
            const rows = table.querySelectorAll('tbody tr');

            const eventsMap = new Map();

            rows.forEach(row => {
                const cells = row.querySelectorAll('td input, td textarea');
                if (cells.length >= 13) {
                    const event = cells[0].value;
                    const eventName = cells[1].value;
                    const purpose = cells[2].value;
                    const trigger = cells[3].value;
                    const parameterName = cells[4].value;

                    if (!eventsMap.has(event)) {
                        eventsMap.set(event, {
                            event: event,
                            eventName: eventName,
                            purpose: purpose,
                            trigger: trigger,
                            parameters: []
                        });
                    }

                    // Adaugă parametrul la eveniment
                    eventsMap.get(event).parameters.push(parameterName);
                }
            });

            // Convertește Map-ul în array
            const eventsArray = Array.from(eventsMap.values());

            // Generează JSON-ul
            const jsonData = JSON.stringify(eventsArray, null, 2);

            const modalHtml = `
                <div class="modal fade" id="jsonModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export JSON - Structura Evenimentelor</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Format JSON:</strong> Structura evenimentelor cu parametrii lor, fără valori.
                                </div>
                                <div class="mb-3">
                                    <label for="jsonData" class="form-label">JSON Data:</label>
                                    <textarea class="form-control" id="jsonData" rows="15" readonly style="font-family: monospace;">${jsonData}</textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="copyJsonToClipboard()">
                                        <i class="bi bi-clipboard"></i> Copiază JSON
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="downloadJson()">
                                        <i class="bi bi-download"></i> Download JSON
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Închide</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('jsonModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru copierea JSON-ului în clipboard
        function copyJsonToClipboard() {
            const textarea = document.getElementById('jsonData');
            textarea.select();
            textarea.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                alert('✅ JSON-ul a fost copiat în clipboard!');
            } catch (err) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert('✅ JSON-ul a fost copiat în clipboard!');
                }).catch(() => {
                    alert('❌ Eroare la copierea JSON-ului!');
                });
            }
        }

        // Funcție pentru download JSON
        function downloadJson() {
            const jsonData = document.getElementById('jsonData').value;
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tagging-events.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funcție pentru adăugarea unui rând custom
        function addCustomRow() {
            const table = document.getElementById('taggingTable');
            const tbody = table.querySelector('tbody');

            // Obține numărul de rânduri existente pentru a genera un index nou
            const existingRows = tbody.querySelectorAll('tr');
            const newRowIndex = existingRows.length;

            // Creează rândul nou
            const newRow = document.createElement('tr');
            newRow.id = 'row-' + newRowIndex;
            newRow.className = 'table-primary';

            // Creează celulele pentru rândul nou
            const cells = [
                { field: 'eventName', placeholder: 'Enter event name...', type: 'input' },
                { field: 'eventCategory', placeholder: 'Enter category...', type: 'input' },
                { field: 'eventDescription', placeholder: 'Enter description...', type: 'input' },
                { field: 'eventLocation', placeholder: 'Enter location...', type: 'input' },
                { field: 'propertyGroup', placeholder: 'Enter group...', type: 'input' },
                { field: 'propertyLabel', placeholder: 'Enter label...', type: 'input' },
                { field: 'propertyName', placeholder: 'Enter property name...', type: 'input' },
                { field: 'propertyDefinition', placeholder: 'Enter definition...', type: 'input' },
                { field: 'dataType', placeholder: 'Enter data type...', type: 'input' },
                { field: 'possibleValues', placeholder: 'Enter possible values...', type: 'input' },
                { field: 'codeExamples', placeholder: 'Enter code examples...', type: 'textarea' },
                { field: 'dataLayerStatus', placeholder: 'yes', type: 'input' },
                { field: 'statusGA4', placeholder: 'yes', type: 'input' }
            ];

            cells.forEach((cell, index) => {
                const td = document.createElement('td');
                let input;

                if (cell.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }

                input.className = 'form-control form-control-sm editable-cell';
                input.name = cell.field + '_' + newRowIndex;
                input.id = cell.field + '_' + newRowIndex;
                input.setAttribute('data-field', cell.field);
                input.setAttribute('data-row-index', newRowIndex);
                input.placeholder = cell.placeholder;

                // Adaugă event listener pentru salvarea automată
                input.addEventListener('blur', function () {
                    const field = this.getAttribute('data-field');
                    const value = this.value;
                    const rowIndex = this.getAttribute('data-row-index');
                    saveCellChange(rowIndex, field, value);
                });

                // Adaugă event listener pentru dublu click
                input.addEventListener('dblclick', function () {
                    this.focus();
                    this.select();
                });

                td.appendChild(input);
                newRow.appendChild(td);
            });

            // Adaugă celula cu butoanele de acțiune
            const actionTd = document.createElement('td');
            actionTd.innerHTML = `
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm edit-btn" 
                            data-row-index="${newRowIndex}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-btn" 
                            data-row-index="${newRowIndex}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            newRow.appendChild(actionTd);

            // Adaugă rândul la tabel
            tbody.appendChild(newRow);

            // Adaugă event listeners pentru butoanele din rândul nou
            const editBtn = newRow.querySelector('.edit-btn');
            const deleteBtn = newRow.querySelector('.delete-btn');

            if (editBtn) {
                editBtn.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    const row = document.getElementById('row-' + rowIndex);
                    const inputs = row.querySelectorAll('.editable-cell');
                    inputs.forEach(input => {
                        input.focus();
                        input.select();
                    });
                });
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    document.getElementById('deleteRowIndex').value = rowIndex;
                    new bootstrap.Modal(document.getElementById('deleteModal')).show();
                });
            }

            // Focus pe prima celulă
            const firstInput = newRow.querySelector('.editable-cell');
            if (firstInput) {
                firstInput.focus();
            }

            // Actualizează contorul de rânduri
            const badge = document.querySelector('.badge.bg-info');
            if (badge) {
                const currentCount = parseInt(badge.textContent.match(/\d+/)[0]);
                badge.textContent = 'Total rânduri: ' + (currentCount + 1);
            }

            // Salvează rândul custom în backend când utilizatorul completează cel puțin un câmp
            const inputs = newRow.querySelectorAll('.editable-cell');
            let isRowSaved = false; // Flag pentru a evita salvarea multiplă

            inputs.forEach(input => {
                input.addEventListener('blur', function () {
                    // Verifică dacă cel puțin un câmp are valoare și rândul nu a fost deja salvat
                    const hasValue = Array.from(inputs).some(inp => inp.value.trim() !== '');
                    if (hasValue && !isRowSaved) {
                        saveCustomRowToBackend(newRowIndex);
                        isRowSaved = true; // Marchează rândul ca fiind salvat
                    }
                });
            });
        }

        // Funcție pentru salvarea rândului custom în backend
        function saveCustomRowToBackend(rowIndex) {
            const row = document.getElementById('row-' + rowIndex);
            const inputs = row.querySelectorAll('.editable-cell');

            const data = {
                eventName: inputs[0].value,
                eventCategory: inputs[1].value,
                eventDescription: inputs[2].value,
                eventLocation: inputs[3].value,
                propertyGroup: inputs[4].value,
                propertyLabel: inputs[5].value,
                propertyName: inputs[6].value,
                propertyDefinition: inputs[7].value,
                dataType: inputs[8].value,
                possibleValues: inputs[9].value,
                codeExamples: inputs[10].value,
                dataLayerStatus: inputs[11].value,
                statusGA4: inputs[12].value
            };

            // Trimite datele către backend
            fetch('/tagging/add-custom-row', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: Object.keys(data).map(key => `${key}=${encodeURIComponent(data[key])}`).join('&')
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Custom row saved successfully');
                    } else {
                        console.error('Failed to save custom row');
                    }
                })
                .catch(error => {
                    console.error('Error saving custom row:', error);
                });
        }

        // Funcție pentru afișarea confirmării de reset
        function showResetConfirmation() {
            const modalHtml = `
                <div class="modal fade" id="resetModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirmare Reset</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Atenție!</strong> Această acțiune va șterge toate rândurile din tabel.
                                </div>
                                <p>Ești sigur că vrei să resetezi tabelul? Această acțiune nu poate fi anulată.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                                <button type="button" class="btn btn-danger" onclick="resetTable()">
                                    <i class="bi bi-trash"></i> Șterge Tot
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('resetModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('resetModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru resetarea tabelului
        function resetTable() {
            // Trimite request către backend pentru reset
            fetch('/tagging/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Reîncarcă pagina pentru a actualiza tabelul
                        window.location.reload();
                    } else {
                        console.error('Failed to reset table');
                        alert('Eroare la resetarea tabelului!');
                    }
                })
                .catch(error => {
                    console.error('Error resetting table:', error);
                    alert('Eroare la resetarea tabelului: ' + error.message);
                });
        }
    </script>
</body>

</html>