<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagging Plan - Google Sheet Style</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/tagging-style.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="logo-container">
                    <img src="/images/logo.png" alt="Logo">
                </div>
                <h1 class="text-center mb-4">Tagging Plan - Event Tracking</h1>

                <!-- Formular pentru selectarea evenimentului și parametrilor -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Selectează Eveniment și Parametri</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/tagging/generate}" method="post">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="selectedEvent" class="form-label">Eveniment:</label>
                                    <select class="form-select" id="selectedEvent" name="selectedEvent" required>
                                        <option value="">-- Selectează un eveniment --</option>
                                        <option th:each="event : ${events}" th:value="${event.event}"
                                            th:text="${event.eventName}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Parametri:</label>
                                    <div class="parameter-checkboxes" style="max-height: 200px; overflow-y: auto;">
                                        <div th:each="parameter : ${parameters}" class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                th:id="'param_' + ${parameter.parameterName}"
                                                th:name="selectedParameters" th:value="${parameter.parameterName}">
                                            <label class="form-check-label"
                                                th:for="'param_' + ${parameter.parameterName}">
                                                <strong th:text="${parameter.parameterName}"></strong> -
                                                <span th:text="${parameter.parameterDescription}"
                                                    class="text-muted"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">Generează Tagging Plan</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tabelul de tip Google Sheet -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Tagging Plan Sheet</h5>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-info"
                                th:text="'Total rânduri: ' + ${#lists.size(taggingRows)}"></span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary btn-sm" id="addCustomRowBtn">
                                    <i class="bi bi-plus-circle"></i> Add Custom Row
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" id="resetTableBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-trash"></i> Reset Table
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="exportBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-download"></i> Export Google Sheet
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="exportCsvBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="exportJsonBtn"
                                    th:disabled="${#lists.isEmpty(taggingRows)}">
                                    <i class="bi bi-file-earmark-code"></i> Export JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover mb-0" id="taggingTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="width: 8%;">Event Name</th>
                                        <th style="width: 8%;">Event Category</th>
                                        <th style="width: 12%;">Event Description</th>
                                        <th style="width: 8%;">Event Location</th>
                                        <th style="width: 8%;">Property Group</th>
                                        <th style="width: 8%;">Property Label</th>
                                        <th style="width: 8%;">Property Name</th>
                                        <th style="width: 15%;">Property Definition</th>
                                        <th style="width: 8%;">Data Type</th>
                                        <th style="width: 10%;">Possible Values</th>
                                        <th style="width: 15%;">Code Examples</th>
                                        <th style="width: 8%;">DATA LAYER STATUS</th>
                                        <th style="width: 8%;">STATUS GA4</th>
                                        <th style="width: 5%;">Actions</th>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Any meaningful action a user takes within your product. By "event"
                                                this refers to a dataLayer event, not necessary with an exact
                                                correspondent in Google Analytics</strong></td>
                                        <td><strong>General category of the event. "Utility" events are not collected
                                                directly, but rather used as support by the rest of the
                                                implementation.</strong></td>
                                        <td><strong>Description of the event being performed (for any given end user to
                                                understand)</strong></td>
                                        <td><strong>The pages where the event can trigger.</strong></td>
                                        <td><strong>Analytics or Custom Property. If Custom Property, the property needs
                                                to be created in Google Analytics</strong></td>
                                        <td><strong>Metric or Dimension</strong></td>
                                        <td><strong>Any rich metadata associated to the event, either describing the
                                                event itself or the user performing that event</strong></td>
                                        <td><strong>Description of the property associated with the event being
                                                performed (for any given end user to understand)</strong></td>
                                        <td><strong>One of six possible data types</strong></td>
                                        <td><strong>Sample value of the property or all possible values. As a general
                                                rule, when the value, for any reason, is not available, the value is set
                                                to undefined</strong></td>
                                        <td><strong>These are examples of how the codes should look like</strong></td>
                                        <td><strong>Whether the event/property has been implemented or not</strong></td>
                                        <td><strong>Whether the event/property has been implemented or not</strong></td>
                                        <td></td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="row, iterStat : ${taggingRows}" th:id="'row-' + ${iterStat.index}"
                                        th:class="${row.eventName != '' and row.eventName != null} ? 'table-primary' : ''">
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventName}" th:name="'eventName_' + ${iterStat.index}"
                                                th:id="'eventName_' + ${iterStat.index}" data-field="eventName"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventName == '' or row.eventName == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventCategory}"
                                                th:name="'eventCategory_' + ${iterStat.index}"
                                                th:id="'eventCategory_' + ${iterStat.index}" data-field="eventCategory"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventCategory == '' or row.eventCategory == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventDescription}"
                                                th:name="'eventDescription_' + ${iterStat.index}"
                                                th:id="'eventDescription_' + ${iterStat.index}"
                                                data-field="eventDescription" th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventDescription == '' or row.eventDescription == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.eventLocation}"
                                                th:name="'eventLocation_' + ${iterStat.index}"
                                                th:id="'eventLocation_' + ${iterStat.index}" data-field="eventLocation"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.eventLocation == '' or row.eventLocation == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyGroup}"
                                                th:name="'propertyGroup_' + ${iterStat.index}"
                                                th:id="'propertyGroup_' + ${iterStat.index}" data-field="propertyGroup"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyGroup == '' or row.propertyGroup == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyLabel}"
                                                th:name="'propertyLabel_' + ${iterStat.index}"
                                                th:id="'propertyLabel_' + ${iterStat.index}" data-field="propertyLabel"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyLabel == '' or row.propertyLabel == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyName}"
                                                th:name="'propertyName_' + ${iterStat.index}"
                                                th:id="'propertyName_' + ${iterStat.index}" data-field="propertyName"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyName == '' or row.propertyName == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.propertyDefinition}"
                                                th:name="'propertyDefinition_' + ${iterStat.index}"
                                                th:id="'propertyDefinition_' + ${iterStat.index}"
                                                data-field="propertyDefinition"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.propertyDefinition == '' or row.propertyDefinition == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.dataType}" th:name="'dataType_' + ${iterStat.index}"
                                                th:id="'dataType_' + ${iterStat.index}" data-field="dataType"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.dataType == '' or row.dataType == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.possibleValues}"
                                                th:name="'possibleValues_' + ${iterStat.index}"
                                                th:id="'possibleValues_' + ${iterStat.index}"
                                                data-field="possibleValues" th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.possibleValues == '' or row.possibleValues == null} ? 'bg-light' : ''">
                                        </td>
                                        <td>
                                            <textarea class="form-control form-control-sm editable-cell"
                                                th:text="${row.codeExamples}"
                                                th:name="'codeExamples_' + ${iterStat.index}"
                                                th:id="'codeExamples_' + ${iterStat.index}" data-field="codeExamples"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.codeExamples == '' or row.codeExamples == null} ? 'bg-light' : ''"
                                                rows="3" placeholder="Enter code examples..."></textarea>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.dataLayerStatus}"
                                                th:name="'dataLayerStatus_' + ${iterStat.index}"
                                                th:id="'dataLayerStatus_' + ${iterStat.index}"
                                                data-field="dataLayerStatus" th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.dataLayerStatus == '' or row.dataLayerStatus == null} ? 'bg-light' : ''"
                                                placeholder="yes">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm editable-cell"
                                                th:value="${row.statusGA4}" th:name="'statusGA4_' + ${iterStat.index}"
                                                th:id="'statusGA4_' + ${iterStat.index}" data-field="statusGA4"
                                                th:attr="data-row-index=${iterStat.index}"
                                                th:class="${row.statusGA4 == '' or row.statusGA4 == null} ? 'bg-light' : ''"
                                                placeholder="yes">
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                                                    title="Edit" th:attr="data-row-index=${iterStat.index}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-btn"
                                                    title="Delete" th:attr="data-row-index=${iterStat.index}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(taggingRows)}">
                                        <td colspan="14" class="text-center text-muted py-4">
                                            Nu există rânduri în tagging plan. Selectează un eveniment și parametri
                                            pentru a genera planul.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal pentru editare -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editare Rând</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/tagging/update}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="editRowIndex" name="rowIndex">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEvent" class="form-label">Event</label>
                                <input type="text" class="form-control" id="editEvent" name="event" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEventName" class="form-label">Event Name</label>
                                <input type="text" class="form-control" id="editEventName" name="eventName" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="editPurpose" class="form-label">Purpose</label>
                                <input type="text" class="form-control" id="editPurpose" name="purpose" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="editTrigger" class="form-label">Trigger</label>
                                <input type="text" class="form-control" id="editTrigger" name="trigger" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editParameterName" class="form-label">Parameter Name</label>
                                <input type="text" class="form-control" id="editParameterName" name="parameterName"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editExampleValue" class="form-label">Example Value</label>
                                <input type="text" class="form-control" id="editExampleValue" name="exampleValue"
                                    required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="editParameterDescription" class="form-label">Parameter Description</label>
                                <input type="text" class="form-control" id="editParameterDescription"
                                    name="parameterDescription" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                        <button type="submit" class="btn btn-primary">Salvează</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pentru confirmare ștergere -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmare Ștergere</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Ești sigur că vrei să ștergi acest rând?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <form th:action="@{/tagging/delete}" method="post" style="display: inline;">
                        <input type="hidden" id="deleteRowIndex" name="rowIndex">
                        <button type="submit" class="btn btn-danger">Șterge</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"></script>
    <script>
        // Funcționalitate pentru editare inline
        document.addEventListener('DOMContentLoaded', function () {
            const editButtons = document.querySelectorAll('.edit-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            const editableCells = document.querySelectorAll('.editable-cell');
            const exportBtn = document.getElementById('exportBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const exportJsonBtn = document.getElementById('exportJsonBtn');

            // Editare inline directă
            editableCells.forEach(cell => {
                cell.addEventListener('dblclick', function () {
                    this.focus();
                    this.select();
                });

                cell.addEventListener('blur', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    const field = this.getAttribute('data-field');
                    const value = this.value;

                    // Verifică că avem datele necesare
                    if (rowIndex && field && value !== undefined) {
                        // Salvează automat modificarea
                        saveCellChange(rowIndex, field, value);
                    }
                });

                cell.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });
            });

            editButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    const row = document.getElementById('row-' + rowIndex);

                    // Populează modalul cu datele din rând
                    document.getElementById('editRowIndex').value = rowIndex;
                    document.getElementById('editEvent').value = row.querySelector('input[name="event_' + rowIndex + '"]').value;
                    document.getElementById('editEventName').value = row.querySelector('input[name="eventName_' + rowIndex + '"]').value;
                    document.getElementById('editPurpose').value = row.querySelector('input[name="purpose_' + rowIndex + '"]').value;
                    document.getElementById('editTrigger').value = row.querySelector('input[name="trigger_' + rowIndex + '"]').value;
                    document.getElementById('editParameterName').value = row.querySelector('input[name="parameterName_' + rowIndex + '"]').value;
                    document.getElementById('editExampleValue').value = row.querySelector('input[name="exampleValue_' + rowIndex + '"]').value;
                    document.getElementById('editParameterDescription').value = row.querySelector('input[name="parameterDescription_' + rowIndex + '"]').value;

                    // Afișează modalul
                    new bootstrap.Modal(document.getElementById('editModal')).show();
                });
            });

            deleteButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    document.getElementById('deleteRowIndex').value = rowIndex;
                    new bootstrap.Modal(document.getElementById('deleteModal')).show();
                });
            });

            // Funcționalitate pentru export
            if (exportBtn) {
                exportBtn.addEventListener('click', function () {
                    // Afișează modal de confirmare pentru export
                    showExportModal();
                });
            }

            // Funcționalitate pentru export CSV
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', function () {
                    // Download direct CSV
                    window.location.href = '/tagging/export-csv';
                });
            }

            // Funcționalitate pentru export JSON
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', function () {
                    // Afișează modal cu JSON
                    showJsonModal();
                });
            }

            // Funcționalitate pentru butonul Add Custom Row
            const addCustomRowBtn = document.getElementById('addCustomRowBtn');
            if (addCustomRowBtn) {
                addCustomRowBtn.addEventListener('click', function () {
                    addCustomRow();
                });
            }

            // Funcționalitate pentru butonul Reset Table
            const resetTableBtn = document.getElementById('resetTableBtn');
            if (resetTableBtn) {
                resetTableBtn.addEventListener('click', function () {
                    showResetConfirmation();
                });
            }
        });

        // Funcție pentru salvarea automată a modificărilor
        function saveCellChange(rowIndex, field, value) {
            console.log('Saving cell change:', { rowIndex, field, value });

            // Verifică că rowIndex este număr
            const numericIndex = parseInt(rowIndex);

            if (isNaN(numericIndex)) {
                console.error('Invalid row index:', rowIndex, 'Type:', typeof rowIndex);
                alert('Eroare: Index rând invalid: ' + rowIndex);
                return;
            }

            // Verifică că field și value sunt valide
            if (!field || value === undefined) {
                console.error('Invalid field or value:', { field, value });
                return;
            }

            // Folosește AJAX pentru a trimite datele
            fetch('/tagging/update-cell', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `rowIndex=${numericIndex}&field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Cell updated successfully');
                    } else {
                        console.error('Failed to update cell, status:', response.status);
                        alert('Eroare la salvarea modificării! Status: ' + response.status);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Eroare la salvarea modificării: ' + error.message);
                });
        }

        // Funcție pentru afișarea modalului de export
        function showExportModal() {
            const modalHtml = `
                <div class="modal fade" id="exportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export Google Sheet</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Vrei să exportezi tagging plan-ul într-un Google Sheet?</p>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Notă:</strong> Se va genera un link către Google Sheets cu datele tale.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                                <button type="button" class="btn btn-success" onclick="exportToGoogleSheets()">
                                    <i class="bi bi-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('exportModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru export către Google Sheets
        function exportToGoogleSheets() {
            // Afișează modal cu datele pentru copiere
            showDataModal();
        }

        // Funcție pentru afișarea datelor în modal
        function showDataModal() {
            // Obține datele din tabel
            const table = document.getElementById('taggingTable');
            const rows = table.querySelectorAll('tbody tr');

            // Obține header-ul cu descrierile din prima linie
            const descriptionRow = table.querySelector('thead tr.table-info');
            const descriptionCells = descriptionRow ? descriptionRow.querySelectorAll('td') : [];

            // Folosește tab-uri în loc de virgule pentru separare
            let csvData = 'Event Name\tEvent Category\tEvent Description\tEvent Location\tProperty Group\tProperty Label\tProperty Name\tProperty Definition\tData Type\tPossible Values\tCode Examples\tDATA LAYER STATUS\tSTATUS GA4\n';

            // Adaugă linia cu descrierile din prima linie a tabelului
            if (descriptionCells.length > 0) {
                const descriptions = Array.from(descriptionCells).map(cell => {
                    // Curăță textul și înlocuiește newline-urile cu spații
                    let text = cell.textContent.trim();
                    // Înlocuiește newline-urile și tab-urile cu spații
                    text = text.replace(/[\n\r\t]+/g, ' ');
                    // Înlocuiește spațiile multiple cu un singur spațiu
                    text = text.replace(/\s+/g, ' ');
                    return text;
                });
                // Exclude ultima celulă (Actions) dacă există
                if (descriptions.length > 10) {
                    descriptions.pop();
                }
                csvData += descriptions.join('\t') + '\n';
            }

            rows.forEach(row => {
                const cells = row.querySelectorAll('td input, td textarea');
                if (cells.length >= 13) {
                    // Extrage valorile din input-uri și textarea-uri
                    const values = Array.from(cells).map(cell => cell.value);

                    // Folosește tab-uri pentru separare - funcționează mult mai bine cu Google Sheets
                    const rowData = values.join('\t');
                    csvData += rowData + '\n';
                }
            });

            const modalHtml = `
                <div class="modal fade" id="dataModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export Data pentru Google Sheets</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i>
                                    <strong>Format Optimizat pentru Google Sheets!</strong> 
                                    <p class="mb-2">Datele sunt formatate cu tab-uri pentru separare perfectă în coloane.</p>
                                    <ol class="mb-0">
                                        <li><strong>Copiază datele</strong> de mai jos (Ctrl+A, Ctrl+C)</li>
                                        <li><strong>Deschide Google Sheets</strong> și creează un sheet nou</li>
                                        <li><strong>Selectează celula A1</strong></li>
                                        <li><strong>Lipește datele</strong> (Ctrl+V)</li>
                                        <li><strong>Datele se organizează automat</strong> în coloane separate!</li>
                                    </ol>
                                </div>
                                <div class="mb-3">
                                    <label for="csvData" class="form-label">Date pentru Google Sheets (format tab-separated):</label>
                                    <textarea class="form-control" id="csvData" rows="10" readonly>${csvData}</textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="copyToClipboard()">
                                        <i class="bi bi-clipboard"></i> Copiază Datele
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="openGoogleSheets()">
                                        <i class="bi bi-google"></i> Deschide Google Sheets
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Închide</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('dataModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru copierea datelor în clipboard
        function copyToClipboard() {
            const textarea = document.getElementById('csvData');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Pentru mobile

            try {
                document.execCommand('copy');
                alert('✅ Datele au fost copiate în clipboard!\n\nAcum poți:\n1. Deschide Google Sheets\n2. Selecta celula A1\n3. Lipi datele (Ctrl+V)');
            } catch (err) {
                // Fallback pentru browsere moderne
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert('✅ Datele au fost copiate în clipboard!\n\nAcum poți:\n1. Deschide Google Sheets\n2. Selecta celula A1\n3. Lipi datele (Ctrl+V)');
                }).catch(() => {
                    alert('❌ Eroare la copierea datelor! Încearcă să selectezi manual textul și să-l copiezi.');
                });
            }
        }

        // Funcție pentru deschiderea Google Sheets
        function openGoogleSheets() {
            window.open('https://docs.google.com/spreadsheets/create', '_blank');
        }

        // Funcție pentru afișarea JSON-ului în modal
        function showJsonModal() {
            // Obține datele din tabel și grupează după event
            const table = document.getElementById('taggingTable');
            const rows = table.querySelectorAll('tbody tr');

            const eventsMap = new Map();

            rows.forEach(row => {
                const cells = row.querySelectorAll('td input, td textarea');
                if (cells.length >= 13) {
                    const event = cells[0].value;
                    const eventName = cells[1].value;
                    const purpose = cells[2].value;
                    const trigger = cells[3].value;
                    const parameterName = cells[4].value;

                    if (!eventsMap.has(event)) {
                        eventsMap.set(event, {
                            event: event,
                            eventName: eventName,
                            purpose: purpose,
                            trigger: trigger,
                            parameters: []
                        });
                    }

                    // Adaugă parametrul la eveniment
                    eventsMap.get(event).parameters.push(parameterName);
                }
            });

            // Convertește Map-ul în array
            const eventsArray = Array.from(eventsMap.values());

            // Generează JSON-ul
            const jsonData = JSON.stringify(eventsArray, null, 2);

            const modalHtml = `
                <div class="modal fade" id="jsonModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export JSON - Structura Evenimentelor</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Format JSON:</strong> Structura evenimentelor cu parametrii lor, fără valori.
                                </div>
                                <div class="mb-3">
                                    <label for="jsonData" class="form-label">JSON Data:</label>
                                    <textarea class="form-control" id="jsonData" rows="15" readonly style="font-family: monospace;">${jsonData}</textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="copyJsonToClipboard()">
                                        <i class="bi bi-clipboard"></i> Copiază JSON
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="downloadJson()">
                                        <i class="bi bi-download"></i> Download JSON
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Închide</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('jsonModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru copierea JSON-ului în clipboard
        function copyJsonToClipboard() {
            const textarea = document.getElementById('jsonData');
            textarea.select();
            textarea.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                alert('✅ JSON-ul a fost copiat în clipboard!');
            } catch (err) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert('✅ JSON-ul a fost copiat în clipboard!');
                }).catch(() => {
                    alert('❌ Eroare la copierea JSON-ului!');
                });
            }
        }

        // Funcție pentru download JSON
        function downloadJson() {
            const jsonData = document.getElementById('jsonData').value;
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tagging-events.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funcție pentru adăugarea unui rând custom
        function addCustomRow() {
            const table = document.getElementById('taggingTable');
            const tbody = table.querySelector('tbody');

            // Obține numărul de rânduri existente pentru a genera un index nou
            const existingRows = tbody.querySelectorAll('tr');
            const newRowIndex = existingRows.length;

            // Creează rândul nou
            const newRow = document.createElement('tr');
            newRow.id = 'row-' + newRowIndex;
            newRow.className = 'table-primary';

            // Creează celulele pentru rândul nou
            const cells = [
                { field: 'eventName', placeholder: 'Enter event name...', type: 'input' },
                { field: 'eventCategory', placeholder: 'Enter category...', type: 'input' },
                { field: 'eventDescription', placeholder: 'Enter description...', type: 'input' },
                { field: 'eventLocation', placeholder: 'Enter location...', type: 'input' },
                { field: 'propertyGroup', placeholder: 'Enter group...', type: 'input' },
                { field: 'propertyLabel', placeholder: 'Enter label...', type: 'input' },
                { field: 'propertyName', placeholder: 'Enter property name...', type: 'input' },
                { field: 'propertyDefinition', placeholder: 'Enter definition...', type: 'input' },
                { field: 'dataType', placeholder: 'Enter data type...', type: 'input' },
                { field: 'possibleValues', placeholder: 'Enter possible values...', type: 'input' },
                { field: 'codeExamples', placeholder: 'Enter code examples...', type: 'textarea' },
                { field: 'dataLayerStatus', placeholder: 'yes', type: 'input' },
                { field: 'statusGA4', placeholder: 'yes', type: 'input' }
            ];

            cells.forEach((cell, index) => {
                const td = document.createElement('td');
                let input;

                if (cell.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }

                input.className = 'form-control form-control-sm editable-cell';
                input.name = cell.field + '_' + newRowIndex;
                input.id = cell.field + '_' + newRowIndex;
                input.setAttribute('data-field', cell.field);
                input.setAttribute('data-row-index', newRowIndex);
                input.placeholder = cell.placeholder;

                // Adaugă event listener pentru salvarea automată
                input.addEventListener('blur', function () {
                    const field = this.getAttribute('data-field');
                    const value = this.value;
                    const rowIndex = this.getAttribute('data-row-index');
                    saveCellChange(rowIndex, field, value);
                });

                // Adaugă event listener pentru dublu click
                input.addEventListener('dblclick', function () {
                    this.focus();
                    this.select();
                });

                td.appendChild(input);
                newRow.appendChild(td);
            });

            // Adaugă celula cu butoanele de acțiune
            const actionTd = document.createElement('td');
            actionTd.innerHTML = `
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm edit-btn" 
                            data-row-index="${newRowIndex}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-btn" 
                            data-row-index="${newRowIndex}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            newRow.appendChild(actionTd);

            // Adaugă rândul la tabel
            tbody.appendChild(newRow);

            // Adaugă event listeners pentru butoanele din rândul nou
            const editBtn = newRow.querySelector('.edit-btn');
            const deleteBtn = newRow.querySelector('.delete-btn');

            if (editBtn) {
                editBtn.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    const row = document.getElementById('row-' + rowIndex);
                    const inputs = row.querySelectorAll('.editable-cell');
                    inputs.forEach(input => {
                        input.focus();
                        input.select();
                    });
                });
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', function () {
                    const rowIndex = this.getAttribute('data-row-index');
                    document.getElementById('deleteRowIndex').value = rowIndex;
                    new bootstrap.Modal(document.getElementById('deleteModal')).show();
                });
            }

            // Focus pe prima celulă
            const firstInput = newRow.querySelector('.editable-cell');
            if (firstInput) {
                firstInput.focus();
            }

            // Actualizează contorul de rânduri
            const badge = document.querySelector('.badge.bg-info');
            if (badge) {
                const currentCount = parseInt(badge.textContent.match(/\d+/)[0]);
                badge.textContent = 'Total rânduri: ' + (currentCount + 1);
            }

            // Salvează rândul custom în backend când utilizatorul completează cel puțin un câmp
            const inputs = newRow.querySelectorAll('.editable-cell');
            let isRowSaved = false; // Flag pentru a evita salvarea multiplă

            inputs.forEach(input => {
                input.addEventListener('blur', function () {
                    // Verifică dacă cel puțin un câmp are valoare și rândul nu a fost deja salvat
                    const hasValue = Array.from(inputs).some(inp => inp.value.trim() !== '');
                    if (hasValue && !isRowSaved) {
                        saveCustomRowToBackend(newRowIndex);
                        isRowSaved = true; // Marchează rândul ca fiind salvat
                    }
                });
            });
        }

        // Funcție pentru salvarea rândului custom în backend
        function saveCustomRowToBackend(rowIndex) {
            const row = document.getElementById('row-' + rowIndex);
            const inputs = row.querySelectorAll('.editable-cell');

            const data = {
                eventName: inputs[0].value,
                eventCategory: inputs[1].value,
                eventDescription: inputs[2].value,
                eventLocation: inputs[3].value,
                propertyGroup: inputs[4].value,
                propertyLabel: inputs[5].value,
                propertyName: inputs[6].value,
                propertyDefinition: inputs[7].value,
                dataType: inputs[8].value,
                possibleValues: inputs[9].value,
                codeExamples: inputs[10].value,
                dataLayerStatus: inputs[11].value,
                statusGA4: inputs[12].value
            };

            // Trimite datele către backend
            fetch('/tagging/add-custom-row', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: Object.keys(data).map(key => `${key}=${encodeURIComponent(data[key])}`).join('&')
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Custom row saved successfully');
                    } else {
                        console.error('Failed to save custom row');
                    }
                })
                .catch(error => {
                    console.error('Error saving custom row:', error);
                });
        }

        // Funcție pentru afișarea confirmării de reset
        function showResetConfirmation() {
            const modalHtml = `
                <div class="modal fade" id="resetModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirmare Reset</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Atenție!</strong> Această acțiune va șterge toate rândurile din tabel.
                                </div>
                                <p>Ești sigur că vrei să resetezi tabelul? Această acțiune nu poate fi anulată.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                                <button type="button" class="btn btn-danger" onclick="resetTable()">
                                    <i class="bi bi-trash"></i> Șterge Tot
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adaugă modalul la DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Afișează modalul
            const modal = new bootstrap.Modal(document.getElementById('resetModal'));
            modal.show();

            // Șterge modalul când se închide
            document.getElementById('resetModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Funcție pentru resetarea tabelului
        function resetTable() {
            // Trimite request către backend pentru reset
            fetch('/tagging/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Reîncarcă pagina pentru a actualiza tabelul
                        window.location.reload();
                    } else {
                        console.error('Failed to reset table');
                        alert('Eroare la resetarea tabelului!');
                    }
                })
                .catch(error => {
                    console.error('Error resetting table:', error);
                    alert('Eroare la resetarea tabelului: ' + error.message);
                });
        }
    </script>
</body>

</html>